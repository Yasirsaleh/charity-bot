const https = require('https');
const querystring = require('querystring');

// ===== معلومات جمعية ياسر للتقنية =====
const ORG_NAME = 'جمعية ياسر للتقنية';
const ORG_INFO = `
1) شروط الاستفادة من الجمعية

الفئات المستهدفة:
- الشباب والباحثون عن عمل والراغبون في تطوير مهارات تقنية.
- الطلاب والطالبات (ثانوي/جامعي/دراسات عليا).
- روّاد الأعمال وأصحاب المشاريع الصغيرة غير التقنية ممن يحتاجون دعمًا تقنيًا أساسيًا.
- الجهات غير الربحية/المدارس (ضمن برامج الشراكات والمسؤولية المجتمعية).
- ذوو الإعاقة (مع أولوية لخدمات الإتاحة الرقمية).

الشروط العامة:
- أن يكون المستفيد داخل المملكة (أو ضمن برامج عن بُعد التي تحددها الجمعية).
- الالتزام بسياسة الاستخدام والسلوك المهني.
- التسجيل في المنصة وتحديث البيانات الأساسية بشكل صحيح.
- الالتزام بالحضور أو متطلبات الإنجاز.
- عدم استخدام الخدمات لأغراض مخالفة للأنظمة.
- أولوية القبول عند تزاحم الطلبات: 1) محدودي الدخل/الباحثين عن عمل 2) طلاب السنة النهائية 3) ذوي الإعاقة 4) سكان المناطق الأقل توفرًا للخدمات التدريبية.

2) الخدمات المقدمة

أولاً - التدريب وبناء المهارات:
- دورات تأسيسية: أساسيات الحاسب، الإنترنت الآمن، Office/Google Workspace.
- مسارات تقنية: برمجة (Python/JavaScript)، تطوير ويب، قواعد بيانات، ذكاء اصطناعي/تحليل بيانات، أمن سيبراني، حوسبة سحابية.
- معسكرات قصيرة (Bootcamps) + مشاريع تطبيقية + تقييم مهارات.

ثانياً - الإرشاد المهني التقني:
- مراجعة السيرة الذاتية التقنية وLinkedIn وGitHub.
- تجهيز مقابلات تقنية (أسئلة + محاكاة مقابلة).
- توجيه لاختيار المسار (خارطة تعلم 8–12 أسبوع).

ثالثاً - حاضنة مشاريع مجتمعية:
- دعم بناء نموذج أولي (MVP) للمشاريع الناشئة الصغيرة.
- إرشاد في اختيار الأدوات والمنصات والهوية التقنية.
- مراجعة تجربة المستخدم UX.

رابعاً - خدمات التحول الرقمي للجهات غير الربحية/المدارس:
- استشارات مبسطة: اختيار أدوات إدارة العمل، البريد، النماذج، إدارة المتطوعين.
- تصميم نماذج إلكترونية.
- بناء صفحة تعريفية بسيطة/موقع تعريفي.

خامساً - التطوع التقني:
- فرص تطوع: تعليم، إعداد محتوى، ترجمة تقنية، دعم فعاليات، تطوير أدوات داخلية.
- منح ساعات تطوع موثقة.

3) مواعيد العمل

المقر/الاستقبال:
- الأحد إلى الخميس: 9:00 صباحاً – 4:00 مساءً
- الجمعة والسبت: إجازة

الدورات والورش:
- مسائي: 6:00 – 9:00 مساءً (أحد–أربعاء غالباً)
- نهاية الأسبوع: 4:00 – 8:00 مساءً (حسب الجدول)

الدعم عبر المنصة/التذاكر: الرد خلال 1–3 أيام عمل.

4) طريقة التقديم
1. الدخول على منصة جمعية ياسر التقنية.
2. إنشاء حساب (رقم جوال/بريد) وتعبئة البيانات الأساسية.
3. اختيار نوع الخدمة: تدريب / إرشاد / احتضان / تحول رقمي / تطوع.
4. رفع المستندات المطلوبة.
5. اختيار موعد أو برنامج مناسب.
6. استلام رسالة تأكيد الطلب.
7. يتم دراسة الطلب ثم: قبول مباشر، أو إدراج في قائمة انتظار، أو طلب معلومات إضافية.

5) المستندات المطلوبة

للتدريب: الهوية الوطنية/الإقامة، إثبات حالة (تعريف طالب أو خطاب باحث عن عمل)، تعهد التزام.
للإرشاد المهني: سيرة ذاتية PDF + رابط LinkedIn، وصف الهدف، رابط GitHub إن وجد.
للاحتضان: عرض فكرة مختصر (1–3 صفحات)، هوية فريق العمل، نماذج/روابط حالية.
للتحول الرقمي: خطاب طلب رسمي، وصف الاحتياج، بيانات مسؤول التواصل.
للتطوع: الهوية، السيرة الذاتية (اختياري)، المهارات التقنية والوقت المتاح.

6) أسئلة متكررة

س: هل خدمات الجمعية مجانية؟
ج: نعم، الجمعية غير ربحية. بعض البرامج قد تتطلب رسوم رمزية لضمان الجدية مع إعفاءات للحالات المستحقة.

س: كيف أعرف أني مقبول؟
ج: سيصلك إشعار عبر المنصة ورسالة SMS/Email مع التفاصيل والجدول.

س: هل يوجد شهادات حضور؟
ج: نعم، تصدر شهادات إلكترونية عند تحقيق متطلبات الحضور/الإنجاز.

س: هل التدريب حضوري أم عن بُعد؟
ج: حسب البرنامج. كل دورة موضح فيها (حضوري/عن بُعد/هجيني).

س: ماذا لو تغيبت عن جلسات؟
ج: عند تجاوز نسبة الغياب يتم إيقافك وإتاحة المقعد لغيرك، ويمكنك إعادة التقديم لاحقاً.

س: هل تقدمون أجهزة لابتوب أو إنترنت؟
ج: ليس دائماً. قد تتوفر منح/إعارات محدودة وفق الشراكات.

س: هل يمكنني التسجيل في أكثر من برنامج؟
ج: نعم، لكن الأولوية لمن لم يستفد سابقاً.

س: كم يستغرق الرد على طلب الإرشاد أو الاحتضان؟
ج: عادة 3–10 أيام عمل.

س: هل يمكن للجهات طلب ورش داخل مقراتها؟
ج: نعم ضمن شراكات مجتمعية حسب توفر المدربين والجدولة.

س: كيف تحمون بياناتي؟
ج: تُستخدم البيانات لأغراض تقديم الخدمة فقط مع تطبيق سياسة خصوصية ولا تُشارك إلا بموافقة أو وفق متطلبات نظامية.
`;
// =====================================

function callClaude(message) {
  return new Promise((resolve, reject) => {
    const apiKey = process.env.CLAUDE_API_KEY;

    const systemPrompt = `أنت المساعد الآلي الرسمي لـ "جمعية ياسر للتقنية" على واتساب.
مهمتك الرد على استفسارات المستفيدين بلغة عربية واضحة وودية ومختصرة.

معلومات الجمعية:
${ORG_INFO}

تعليمات مهمة:
- رد بشكل مختصر ومفيد (لا تتجاوز 6 أسطر إلا إذا السؤال يحتاج تفصيل)
- لا تستخدم تنسيق markdown أو نجوم أو رموز خاصة
- استخدم الأرقام العربية والنقاط البسيطة
- لا تختلق معلومات غير موجودة في البيانات أعلاه
- إذا سُئلت عن شيء غير موجود في المعلومات، قل: "هذه المعلومة غير متوفرة لدي حالياً، يمكنك التواصل مع الجمعية مباشرة"
- ابدأ الرد بتحية ودية مختصرة
- في نهاية الرد يمكنك سؤال "هل تحتاج مساعدة في شيء آخر؟"`;

    const requestBody = JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 400,
      system: systemPrompt,
      messages: [{ role: 'user', content: message }]
    });

    const options = {
      hostname: 'api.anthropic.com',
      path: '/v1/messages',
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'Content-Length': Buffer.byteLength(requestBody)
      }
    };

    const req = https.request(options, (res) => {
      let body = '';
      res.on('data', (chunk) => body += chunk);
      res.on('end', () => {
        try {
          const data = JSON.parse(body);
          if (data.content && data.content[0]) {
            resolve(data.content[0].text);
          } else {
            resolve('عذراً، لم أتمكن من الرد حالياً. يرجى التواصل مع جمعية ياسر للتقنية مباشرة.');
          }
        } catch (e) {
          resolve('عذراً، حدث خطأ تقني. يرجى المحاولة لاحقاً.');
        }
      });
    });

    req.on('error', () => resolve('عذراً، حدث خطأ في الاتصال. يرجى المحاولة لاحقاً.'));
    req.write(requestBody);
    req.end();
  });
}

exports.handler = async (event) => {
  if (event.httpMethod !== 'POST') {
    return { statusCode: 200, body: 'Yasser Tech Association WhatsApp Bot is running' };
  }

  try {
    const params = querystring.parse(event.body);
    const incomingMessage = params.Body || '';
    const from = params.From || '';

    console.log(`Message from ${from}: ${incomingMessage}`);

    const reply = await callClaude(incomingMessage);

    const twiml = `<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Message>${reply.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</Message>
</Response>`;

    return {
      statusCode: 200,
      headers: { 'Content-Type': 'text/xml' },
      body: twiml
    };

  } catch (error) {
    console.error('Error:', error);
    const twiml = `<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Message>عذراً، حدث خطأ تقني. يرجى المحاولة لاحقاً أو التواصل مع جمعية ياسر للتقنية مباشرة.</Message>
</Response>`;

    return {
      statusCode: 200,
      headers: { 'Content-Type': 'text/xml' },
      body: twiml
    };
  }
};
